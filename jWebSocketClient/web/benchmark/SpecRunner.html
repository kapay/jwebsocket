<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
	"http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Jasmine Test Runner</title>
		<link rel="stylesheet" type="text/css" href="../res/jasmine-1.0.2/jasmine.css">
		<script type="text/javascript" src="../res/jasmine-1.0.2/jasmine.js"></script>
		<script type="text/javascript" src="../res/jasmine-1.0.2/jasmine-html.js"></script>
		<script type="text/javascript" src="../res/jWebSocket.js"></script>
		<script type="text/javascript" src="../res/jwsAPIPlugIn.js"></script>

		<!-- include source files here... -->
		<script type="text/javascript" src="src/TestPlugInHelper.js"></script>

		<!-- include spec files here... -->
		<script type="text/javascript" src="spec/Matchers.js"></script>

	</head>
	<body>

		<script type="text/javascript">
			
			if(jws.browserSupportsWebSockets()){
				
				conn = new jws.jWebSocketJSONClient();
				conn.open(jws.JWS_SERVER_URL, {
					OnOpen: function (){
						connections_opened = 0;
						connections = [];
						
						
						describe("Open 100 connections", function (){
							it('Open 100 connections', function () {
								
								testing.initTimeMarks[testing.initTimeMarksIndex++] = new Date().getTime();
								for (var i = 0; i < 100; i++){
									connections[i] = new jws.jWebSocketJSONClient();
									connections[i].open(jws.JWS_SERVER_URL, {
										OnOpen: function (){
											connections_opened++;
										}, 
										OnClose: function (){
											connections_opened--;
										}
									});
								}
								
								testing.report[testing.reportIndexI++] = 0;
								waitsFor(function() {
									return connections_opened == 100;
								}, 'opening connection...', 10000);
								
								runs(function () {
									expect(connections_opened).toEqual(100);
									testing.report[testing.reportIndexI - 1] = (new Date().getTime() - testing.initTimeMarks[testing.initTimeMarksIndex - 1]);
								});

							});
						});
						
						
						server = new jws.APIPlugIn(conn);

						server.plugInAPI("jws.benchmark", function (p){
							testing.describePlugIn(p);
								
							describe("Closing 100 connections", function (){
								it('Close 100 connections', function () {
								
									testing.initTimeMarks[testing.initTimeMarksIndex++] = new Date().getTime();
									for (var i = 0; i < 100; i++){
										connections[i].close();
									}
									
									testing.report[testing.reportIndexI++] = 0;
									waitsFor(function() {
										return connections_opened == 0;
									}, 'closing connection...', 10000);
								
									runs(function () {
										expect(connections_closed).toEqual(100);
										testing.report[testing.reportIndexI - 1] = (new Date().getTime() - testing.initTimeMarks[testing.initTimeMarksIndex - 1]);
									});

								});
							});
							
							setTimeout(function (){
								jasmine.getEnv().addReporter(new jasmine.TrivialReporter());
								jasmine.getEnv().execute();
							}, 500);
							
					
						});	
						
						
					}	

				});
			} else {
				var lMsg = jws.MSG_WS_NOT_SUPPORTED;
				alert( lMsg );
				log( lMsg );
			}
		</script>

	</body>
</html>
