<html>
  <head>
    <!--
//	****************************************************************************
//	jWebSocket Simple Chat (uses jWebSocket Client and Server)
//	Copyright (c) 2010 Alexander Schulze, Innotrade GmbH, Herzogenrath
//	****************************************************************************
//	This program is free software; you can redistribute it and/or modify it
//	under the terms of the GNU Lesser General Public License as published by the
//	Free Software Foundation; either version 3 of the License, or (at your
//	option) any later version.
//	This program is distributed in the hope that it will be useful, but WITHOUT
//	ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
//	FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for
//	more details.
//	You should have received a copy of the GNU Lesser General Public License along
//	with this program; if not, see <http://www.gnu.org/licenses/lgpl.html>.
//	****************************************************************************
//  Author:Unni Vemanchery Mana

//  This demo is used to show the capabilities of jWebsocket in video streaming.
//  This example works similar to parent child relationship in which parent window
//  ie first window that is loaded in browser takes control of the video streaming.The
//  other window(s) who opened after the main one will be its children. 
-->


    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script src="../../res/js/jWebSocket.js" type="text/javascript"></script> 
    <script type="text/javascript" src="slider.js"></script>
    <link href="default.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="../../res/css/jwebsocket.css">
  </head>
  <body>

  <script language = "javascript">
   var video;
   var lWSC ;
   var mouseDragged = false;
   var duration = 0;
   var deltaTime = 0;
   var timer = null;
   var s = 0;
   var m = 0;
   var h = 0;
   var deltav = 1;
   var sliderid = null;
   var paused = false;
   var sltimer = 0;
    var tmpv = 0;

	// this method starts playing the video.
   function playVideo() {
   if(video == null || video == undefined) {
        alert("Video has not been initialized..");
         return false;
     }

    // calculating video duration and time increment in delta
       calculateVideoDuration(); 
       m = 0;  
       h = 0; 
       totalTime = 0;
  }

  // Retrieves the length of the current playing video
 //  in seconds
  function calculateVideoDuration() {
      if(video.readyState > 0 && paused == false) {
         timer.firstChild.nodeValue = "00:00:00";

           duration = video.duration.toFixed(2);
           deltaTime = (duration / 99.00).toFixed(2) ;
           
          // starts video timer;
          startTimer(); 
          
         // starts slider timer
         startSliderTimer();

        // play video  
       video.play();
      } else {
        video.play();
      } 
  } 


  // The starter method for all the causes.
  function start() {
    if(paused == false) {
    video = jws.$( "vid" );
    timer = jws.$( "timer" );
    sliderid = jws.$( "slider1" );
    initialize(); 
    deltav = 1; 
    playVideo();     
    sliderMove = sliderMoveHandler;
    handleMouseMove = handleMouseMoveCB;
    handleMouseUp   = handleMouseUpCB;
    initializeWebSocket();
    logon(); 
    }         
    else {
      playVideo();     
    }
  }

  function initialize() {
    deltav = 1;
    slideAutomatic(deltav, true);
  }
  
  // This method is used to pause the
  // current video play
  function pause() {
     if(video) {
       paused = true;
       video.pause();
     }
  }

  // This method is used to stop the 
  // current video play as abort is 
  // not a method and cannot be used. 
  function stop() {
     if(video) {
       video.currentTime = duration + 10;  
       timer.firstChild.nodeValue = "00:00:00";
       paused = false;
       mouseDragged = false;
       st = 0;
       window.clearInterval( sltimer );    
       initialize();
     }
  }


  // This is the callback function for moving slider.
  // If drag was successful, it will broadcast 
  // elapsed slider units of the current playing video.
  function sliderMoveHandler(v) {
     deltav = v;   
  }

  // This method adjusts video current time to s
  // so that it will be in sync with video current
  // time
  function displayTimer() {
     m =  parseInt(video.currentTime/60);
     s =  parseInt(video.currentTime % 60);
	 timer.firstChild.nodeValue = (h <10?"0"+h:h) + ":" + (m <60?"0"+m:""+m) + ":" + (s <10?"0"+s:""+s);
  }


  // This method is used to track the timer for the video
  // progress event.The timer ticks for every one second 
  function startTimer() {
		t = window.setInterval(function() {
			if (video.ended != true) {
			        displayTimer(); 				
	//			timer.firstChild.nodeValue = (h <10?"0"+h:h) + ":" + (m <60?"0"+m:""+m) + ":" + (s <10?"0"+s:""+s);
			} else {
                                m = 0;  
                                h = 0;
                                st = 0; 
                                deltav = 100;
                                moveSliderAuto(deltav, true); 
				                window.clearInterval(t); 
                                window.clearInterval( sltimer ); 
                                log("video ended:");   
			}
		},1000);
 }

  // move slider autiomatically
  function moveSliderAuto() {
  	  slideAutomatic(deltav, true);
      deltav = deltav + 1;
	  sendData( deltav );
  }

  // timer to start the slider
  function startSliderTimer() {
    var stimer =  deltaTime * 1000 ;
     sltimer = window.setInterval(function() {
     slideAutomatic(deltav, true);
     deltav = deltav + 1;
     sendData( deltav );
   }, stimer);
  }


  // starting the slider timer
  function sliderTimer() {
    moveSliderAuto();   
  } 
  
  // Added the code for handling whether the user
  // started dragging the slider  
  function handleMouseMoveCB(e) {
      window.clearInterval( sltimer ); 
      mouseDragged = true;
     }

   
  // Added code for handling mouse release callback
  function handleMouseUpCB() {
    mouseDragged = false;
	video.currentTime = Math.round(deltav * deltaTime);
	displayTimer();
    startSliderTimer();
	sendData( deltav );
  }
  

  // Initializing web socket
  function initializeWebSocket() {
   if( jws.browserSupportsWebSockets()) {
      lWSC = new jws.jWebSocketJSONClient();
    }
   }


  // This is the generic call back related to web socket
  // This following code will execute based on the events
  function logon() {
   var lURL = jws.JWS_SERVER_URL + "/;prot=json,timeout=360000";
   lWSC.logon( lURL, "test", "", {

  		// OnOpen callback
		OnOpen: function( aEvent ) {
			checkKeepAlive({ immediate: false });
		},

		OnMessage: function( aEvent, aToken ) {
						if( aToken ) {
							// is it a response from a previous request of this client?
							if( aToken.type == "response" ) {
								// figure out of which request
								if( aToken.reqType == "login" ) {
									if( aToken.code == 0 ) {
										// call getAuthClients method from
										// jWebSocket System Client Plug-In
										lWSC.getAuthClients({
											pool: null
										});
									} else {
										// select username again for convenience
									}
								} else if( aToken.reqType == "getClients" ) {
								}
							} else if( aToken.type == "event" ) {
                                            log(aToken.data); 
							} else if( aToken.type == "goodBye" ) {
							} else if( aToken.type == "broadcast" ) {
                                                          getData(aToken);
							} else if(aToken.type == "send" ) {
                                          } 
						}
					},


     					// OnClose callback
					OnClose: function( aEvent ) {
						lWSC.stopKeepAlive();
					}

   });
  }

  // this method makes the websocket connection keep alive
  function checkKeepAlive( aOptions ) {
 	if( !aOptions ) {
	  aOptions = {};
	}
	aOptions.interval = 30000;
	lWSC.startKeepAlive( aOptions );
}


  // This method takes care of call back
  // and moves the slider automatically with the 
  // value broadcasted by its peer. Note that the method
  // is checking to avoid the current slider not to move
  function getData(token) {
      video.currentTime = Math.round(token.data * deltaTime);
	  displayTimer();
	  window.clearInterval( sltimer ); 
	  deltav = token.data;
      slideAutomatic(token.data, true);
  }
 
  // This method broadcasts the data to its subordinates.
  function sendData(data) {
   var res = lWSC.broadcastText("",data);
  }


  // Logs activities to console
  function log(msg) {
   if(msg != undefined)
   jws.$( "data" ).innerHTML = msg;
  }

  </script>

   <h1 style="position:absolute; top: 10px; left: 90px;">Video Streaming Demo</h1>

   <!-- HTML5 enabled video attribute that plays video. 
    In order to make a custom video control, we need to
    remove 'control' attribute. height and width attribute
    specfied its dimensions.The video type currently uses
    webm standdard, yet another video format type initiated
    by google and ogv.  
   -->
   <video id="vid"  height = "240"  width = "420" style="position:absolute; top: 50px; left: 15px;">
     
     <source src="sintel-trailer.ogv" type='video/ogg; codecs="theora, vorbis"'> 
     
     <!--
     <source src="pr6.webm"> -->
   </video>


<!--
   The slider component which is a third party component (http://carpe.ambiprospect.com/).
-->
<div class="carpe_horizontal_slider_display_combo" style="position:absolute; top: 295px; left: 65px;">
	<div class="carpe_slider_display_holder">
		<!-- Default value: 0 -->
		<input class="carpe_slider_display" id="display1" type="text" value="1" />
	</div>
	<div class="carpe_horizontal_slider_track">
		<div class="carpe_slider_slit" style="width: 100px; ">&nbsp;</div>
		<div class="carpe_slider" id="slider1" display="display1" distance="100">&nbsp;</div>
	</div>
</div>



<div id="timer" style="position: absolute; top: 295px; left: 235px;">00:00:00&nbsp;
</div>

<!-- Volume control slider -->
<div class="carpe_horizontal_slider_display_combo" style="position:absolute; top: 295px; left: 300px; width: 25px;">
	<div class="carpe_slider_display_holder">
		<!-- Default value: 0 -->
		<input class="carpe_slider_display" id="display2" type="text" value="0" />
	</div>
	<div class="carpe_horizontal_slider_track" style="position:absolute; left: 38px; width: 37px; ">
		<div class="carpe_slider_slit" style="width: 25px; ">&nbsp;</div>
		<div class="carpe_slider" id="slider2" display="display2" distance="25">&nbsp;</div>
	</div>
</div>


<input type = "button" name = "btn" value = "Play"  onclick = "start()" class="sbtnDlg" style="position:absolute; top: 325px; left: 58px;"> 
<input type = "button" name = "btn" value = "Pause" onclick = "pause()" class="sbtnDlg" style="position:absolute; top: 325px; left: 171px;">
<input type = "button" name = "btn" value = "Stop"  onclick = "stop()"  class="sbtnDlg"  style="position:absolute; top: 325px; left: 283px;">


  <div id = "spd" style="position:absolute; top: 295px; left: 80px;"></div>
  <div id = "data" style="position:absolute; top: 315px; left: 80px;"></div>
  <div id = "tim" style="position:absolute; top: 325px; left: 80px;"></div>

 </body>
</html>
